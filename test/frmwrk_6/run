source ../test_functions.bsh

setup

# remove and create the unit_test
create_unit_test.pl -overwrite -out ./test_unit_test.sv test.sv
create_unit_test.pl -overwrite -out ./subdir0/subdir0_unit_test.sv ./subdir0/subdir0.sv
create_unit_test.pl -overwrite -out ./subdir1/subdir1_unit_test.sv ./subdir1/subdir1.sv
create_unit_test.pl -overwrite -out ./subdir1/subdir1a/subdir1a_unit_test.sv ./subdir1/subdir1a/subdir1a.sv

# create the Makefile
create_svunit.pl

# verify that the Makefiles in each dir have only the UNITTESTS and INCDIRS that are required
expect_file_does_not_contain subdir1 subdir0/Makefile &&
expect_file_does_not_contain subdir0 subdir1/Makefile &&
expect_file_does_not_contain subdir0 subdir1/subdir1a/Makefile &&
expect_file_does_not_contain "subdir1 " subdir1/subdir1a/Makefile
expect_return_code 0

## build the svunit_top
make .testrunner.sv

# generate golden reference files
golden_testrunner_with_4_testsuites

# verify the output
verify_testrunner testrunner.gold subdir0 subdir1_subdir1a subdir1

exit 0
