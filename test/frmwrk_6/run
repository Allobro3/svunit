source ../test_functions.bsh

setup

# remove and create the unit_test
create_unit_test.pl -overwrite -out ./test_unit_test.sv test.sv
create_unit_test.pl -overwrite -out ./subdir0/subdir0_unit_test.sv ./subdir0/subdir0.sv
create_unit_test.pl -overwrite -out ./subdir1/subdir1_unit_test.sv ./subdir1/subdir1.sv
create_unit_test.pl -overwrite -out ./subdir1/subdir1a/subdir1a_unit_test.sv ./subdir1/subdir1a/subdir1a.sv

# create the Makefile
create_svunit.pl

# verify that the Makefiles in each dir have only the UNITTESTS and INCDIRS that are required
grep subdir1 subdir0/Makefile >/dev/null
if [ "$?" == "0" ]; then
  echo subdir0/Makefile includes references to subdir1*
  exit 1;
fi

grep subdir0 subdir1/Makefile >/dev/null
if [ "$?" == "0" ]; then
  echo subdir1/Makefile includes references to subdir0
  exit 1;
fi

grep subdir0 subdir1/subdir1a/Makefile >/dev/null
if [ "$?" == "0" ]; then
  echo subdir1/subdir1a/Makefile includes references to subdir0
  exit 1;
fi

grep "subdir1 " subdir1/subdir1a/Makefile >/dev/null
if [ "$?" == "0" ]; then
  echo subdir1/subdir1a/Makefile includes references to subdir1
  exit 1;
fi

## build the svunit_top
make .svunit_top.sv

verify_file test_unit_test.gold test_unit_test.sv
verify_testsuite testsuite.gold
verify_testrunner testrunner.gold

cd subdir0
verify_file subdir0_unit_test.gold subdir0_unit_test.sv
verify_testsuite testsuite.gold

cd ../subdir1
verify_file subdir1_unit_test.gold subdir1_unit_test.sv
verify_testsuite testsuite.gold

cd subdir1a
verify_file subdir1a_unit_test.gold subdir1a_unit_test.sv
verify_testsuite testsuite.gold

exit 0
